{"version":3,"sources":["../src/call.js"],"names":["ensureH264","offer","sdp","parse","video","media","type","Error","doesHaveH264","rtp","reduce","hasH264","codec","includes","Call","extend","namespace","session","locus","pc","localMediaStream","localMediaStreamUrl","remoteMediaStream","remoteMediaStreamUrl","sendingAudio","sendingVideo","receivingAudio","receivingVideo","wasSendingAudio","wasSendingVideo","wasReceivingAudio","wasReceivingVideo","locusJoinInFlight","default","locusLeaveInFlight","derived","isActive","deps","fn","activeParticipants","activeParticipantsCount","length","joined","joinedOnThisDevice","spark","locusUrl","url","device","self","devices","item","mediaConnection","mediaConnections","mediaId","remoteAudioMuted","remote","remoteVideoMuted","direction","from","local","to","status","state","localAudioDirection","toLowerCase","localVideoDirection","remoteAudioDirection","remoteVideoDirection","initialize","args","prototype","forEach","key","listenTo","mercury","event","_onLocusEvent","on","stopListening","off","URL","revokeObjectURL","undefined","RTCPeerConnection","iceServers","ontrack","streams","createObjectURL","trigger","logger","info","hangup","previousLocus","previousAttributes","answer","options","_join","then","acknowledge","alert","_setLocus","dial","invitee","catch","reason","when","resolve","_hangup","leave","set","decline","reject","startSendingAudio","_changeMedia","startSendingVideo","startReceivingAudio","startReceivingVideo","toggleReceivingAudio","stopReceivingAudio","toggleReceivingVideo","stopReceivingVideo","toggleSendingAudio","stopSendingAudio","toggleSendingVideo","stopSendingVideo","sendFeedback","feedback","metrics","submit","constraints","promises","push","all","_updateMedia","unset","locusMethodName","target","audio","recvOnly","offerOptions","offerToReceiveAudio","offerToReceiveVideo","promise","phone","createLocalMediaStream","wantsVideo","localSdp","JSON","remoteSdp","data","eventType","incoming","current","action","compare","get","process","nextTick","updateMedia","audioMuted","videoMuted","make","attrs"],"mappings":"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","file":"call.js","sourcesContent":["/**!\n *\n * Copyright (c) 2016 Cisco Systems, Inc. See LICENSE file.\n * @private\n */\n\n/* eslint-env browser: true */\n/* global RTCPeerConnection, RTCSessionDescription */\n\nimport {SparkPlugin} from '@ciscospark/spark-core';\nimport {oneFlight, tap} from '@ciscospark/common';\nimport {\n  eventKeys,\n  USE_INCOMING,\n  FETCH\n} from '@ciscospark/plugin-locus';\nimport {defaults, find} from 'lodash';\nimport {\n  createOffer,\n  acceptAnswer,\n  end,\n  mediaDirection as mediaDirectionFromPeerConnection,\n  addStream,\n  stopSendingAudio,\n  stopSendingVideo,\n  startSendingAudio,\n  startSendingVideo,\n  stopReceivingAudio,\n  stopReceivingVideo,\n  startReceivingAudio,\n  startReceivingVideo\n} from './webrtc';\nimport {\n  activeParticipants,\n  direction,\n  isActive,\n  joined,\n  joinedOnThisDevice,\n  participantIsJoined,\n  remoteAudioMuted,\n  remoteParticipant,\n  remoteVideoMuted\n} from './state-parsers';\n\nimport transform from 'sdp-transform';\n\n/**\n * Checks a given offer for the h264 codec\n * @param {string} offer\n * @returns {string}\n */\nfunction ensureH264(offer) {\n  const sdp = transform.parse(offer);\n  const video = find(sdp.media, {type: `video`});\n  if (!video) {\n    throw new Error(`Expected video section in offer but no such section found`);\n  }\n\n  const doesHaveH264 = video.rtp.reduce((hasH264, rtp) => hasH264 || rtp.codec.includes(`264`), false);\n  if (!doesHaveH264) {\n    throw new Error(`Offer includes video section but does not include h264 codec`);\n  }\n\n  return offer;\n}\n\n/**\n * @event ringing\n * @instance\n * @memberof Call\n */\n\n/**\n * @event connected\n * @instance\n * @memberof Call\n */\n\n/**\n * @event disconnected\n * @instance\n * @memberof Call\n */\n\n/**\n * @event localMediaStream:change\n * @instance\n * @memberof Call\n */\n\n/**\n * @event remoteMediaStream:change\n * @instance\n * @memberof Call\n */\n\n/**\n * @event error\n * @instance\n * @memberof Call\n */\n\n/**\n * Payload for {@link Call#sendFeedback}\n * @typedef {Object} Types~Feedback\n * @property {number} userRating Number between 1 and 5 (5 being best) to let\n * the user score the call\n * @property {string} userComments Freeform feedback from the user about the\n * call\n * @property {Boolean} includeLogs set to true to submit client logs to the\n * Cisco Spark cloud. Note: at this time, all logs, not just call logs,\n * generated by the sdk will be uploaded to the Spark Cloud. Care has been taken\n * to avoid including PII in these logs, but if you've taken advantage of the\n * SDK's logger, you should make sure to avoid logging PII as well.\n */\n\n/**\n * @class\n * @extends SparkPlugin\n */\nconst Call = SparkPlugin.extend({\n  namespace: `Phone`,\n\n  session: {\n    locus: `object`,\n    pc: `object`,\n    /**\n     * Returns the local MediaStream for the call. May initially be `null`\n     * between the time @{Phone#dial is invoked and the  media stream is\n     * acquired if {@link Phone#dial} is invoked without a `localMediaStream`\n     * option.\n     *\n     * This property can also be set mid-call in which case the streams sent to\n     * the remote party are replaced by this stream. On success, the\n     * {@link Call}'s {@link localMediaStream:change} event fires, notifying any\n     * listeners that we are now sending media from a new source.\n     * @instance\n     * @memberof Call\n     * @member {MediaStream}\n     * @readonly\n     */\n    localMediaStream: `object`,\n    // TODO determine if stream URLs can be deprecated; it looks like the video\n    // tag may accept streams directly these days.\n    /**\n     * Object URL that refers to {@link Call#localMediaStream}. Will be\n     * automatically deallocated when the call ends\n     * @instance\n     * @memberof Call\n     * @member {string}\n     */\n    localMediaStreamUrl: `string`,\n    /**\n     * Access to the remote party’s `MediaStream`.\n     * @instance\n     * @memberof Call\n     * @member {MediaStream}\n     * @readonly\n     */\n    remoteMediaStream: `object`,\n    /**\n     * Object URL that refers to {@link Call#remoteMediaStream}. Will be\n     * automatically deallocated when the call ends\n     * @instance\n     * @memberof Call\n     * @member {string}\n     * @readonly\n     */\n    remoteMediaStreamUrl: `string`,\n    /**\n     * Indicates if the client is sending audio\n     * @instance\n     * @memberof Call\n     * @member {Boolean}\n     * @readonly\n     */\n    sendingAudio: `boolean`,\n    /**\n     * Indicates if the client is sending video\n     * @instance\n     * @memberof Call\n     * @member {Boolean}\n     * @readonly\n     */\n    sendingVideo: `boolean`,\n    /**\n     * Indicates if the client is receiving audio\n     * @instance\n     * @memberof Call\n     * @member {Boolean}\n     * @readonly\n     */\n    receivingAudio: `boolean`,\n    /**\n     * Indicates if the client is receiving video\n     * @instance\n     * @memberof Call\n     * @member {Boolean}\n     * @readonly\n     */\n    receivingVideo: `boolean`,\n\n    wasSendingAudio: `boolean`,\n    wasSendingVideo: `boolean`,\n    wasReceivingAudio: `boolean`,\n    wasReceivingVideo: `boolean`,\n    locusJoinInFlight: {\n      default: false,\n      type: `boolean`\n    },\n    locusLeaveInFlight: {\n      default: false,\n      type: `boolean`\n    }\n  },\n\n  // FIXME in its current form, any derived property that is an object will emit\n  // a change event everytime a locus gets replaced, even if no values change\n  derived: {\n    isActive: {\n      deps: [`locus`],\n      fn() {\n        return this.locus && isActive(this.locus);\n      }\n    },\n    activeParticipants: {\n      deps: [`locus`],\n      fn() {\n        return activeParticipants(this.locus);\n      }\n    },\n    activeParticipantsCount: {\n      deps: [`activeParticipants`],\n      fn() {\n        return this.activeParticipants.length;\n      }\n    },\n    joined: {\n      deps: [`locus`],\n      default: false,\n      fn() {\n        return this.locus && joined(this.locus);\n      }\n    },\n    joinedOnThisDevice: {\n      deps: [`locus`],\n      default: false,\n      fn() {\n        return this.locus && joinedOnThisDevice(this.spark, this.locus);\n      }\n    },\n    locusUrl: {\n      deps: [`locus`],\n      fn() {\n        return this.locus.url;\n      }\n    },\n    device: {\n      deps: [`locus`],\n      fn() {\n        return this.locus.self && find(this.locus.self.devices, (item) => item.url === this.spark.device.url);\n      }\n    },\n    mediaConnection: {\n      deps: [`device`],\n      fn() {\n        return this.device && this.device.mediaConnections[0];\n      }\n    },\n    mediaId: {\n      deps: [`mediaConnection`],\n      fn() {\n        return this.mediaConnection && this.mediaConnection.mediaId;\n      }\n    },\n    remoteAudioMuted: {\n      deps: [`remote`],\n      fn() {\n        return remoteAudioMuted(this.remote);\n      }\n    },\n    remoteVideoMuted: {\n      deps: [`remote`],\n      fn() {\n        return remoteVideoMuted(this.remote);\n      }\n    },\n    direction: {\n      deps: [`locus`],\n      fn() {\n        // This seems brittle, but I can't come up with a better way. The only\n        // way we should have a Call without a locus is if we just initiated a\n        // call but haven't got the response from locus yet.\n        if (!this.locus) {\n          return `out`;\n        }\n        return direction(this.locus);\n      }\n    },\n    from: {\n      deps: [\n        `direction`,\n        `local`,\n        `remote`\n      ],\n      fn() {\n        return this.direction === `out` ? this.local : this.remote;\n      }\n    },\n    to: {\n      deps: [\n        `direction`,\n        `local`,\n        `remote`\n      ],\n      fn() {\n        return this.direction === `in` ? this.local : this.remote;\n      }\n    },\n    local: {\n      deps: [`locus`],\n      fn() {\n        return this.locus && this.locus.self;\n      }\n    },\n    remote: {\n      deps: [`locus`],\n      fn() {\n        return this.locus && remoteParticipant(this.locus);\n      }\n    },\n    /**\n     * <b>initiated</b> - Offer was sent to remote party but they have not yet accepted <br>\n     * <b>ringing</b> - Remote party has acknowledged the call <br>\n     * <b>connected</b> - At least one party is still on the call <br>\n     * <b>disconnected</b> - All parties have dropped <br>\n     * @instance\n     * @memberof Call\n     * @member {string}\n     * @readonly\n     */\n    status: {\n      deps: [\n        `joinedOnThisDevice`,\n        `local`,\n        `remote`\n      ],\n      fn() {\n        if (this.joinedOnThisDevice && this.remote && participantIsJoined(this.remote)) {\n          return `connected`;\n        }\n\n        if (this.remote && this.local) {\n          if (this.remote.state === `LEFT` || this.local.state === `LEFT`) {\n            return `disconnected`;\n          }\n\n          if (this.remote.state === `DECLINED`) {\n            return `disconnected`;\n          }\n\n          if (this.remote.state === `NOTIFIED`) {\n            return `ringing`;\n          }\n        }\n\n        return `initiated`;\n      }\n    },\n    localAudioDirection: {\n      deps: [`locus`],\n      fn() {\n        return mediaDirectionFromPeerConnection(`audio`, this.pc).toLowerCase();\n      }\n    },\n    localVideoDirection: {\n      deps: [`locus`],\n      fn() {\n        return mediaDirectionFromPeerConnection(`video`, this.pc).toLowerCase();\n      }\n    },\n    remoteAudioDirection: {\n      deps: [`locus`],\n      fn() {\n        // Until Locus fixes the bug that prevents do both renegotiation and\n        // state update, we can't trust the remote direction from the locus\n        return `unknown`;\n      }\n    },\n    remoteVideoDirection: {\n      deps: [`locus`],\n      fn() {\n        // Until Locus fixes the bug that prevents do both renegotiation and\n        // state update, we can't trust the remote direction from the locus\n        return `unknown`;\n      }\n    }\n  },\n\n  /**\n   * Initializer\n   * @private\n   * @param {Object} attrs\n   * @param {Object} options\n   * @returns {undefined}\n   */\n  initialize(...args) {\n    Reflect.apply(SparkPlugin.prototype.initialize, this, args);\n\n    // We can't trust the mercury event name, so we need to pipe all locus\n    // events through the same handler.\n    // TODO adjust plugin-mercury to emit events by namespace so we can listen\n    // for incoming locus events in a single handler.\n    eventKeys.forEach((key) => {\n      this.listenTo(this.spark.mercury, `event:${key}`, (event) => this._onLocusEvent(event));\n    });\n\n    this.on(`disconnected`, () => {\n      this.stopListening(this.spark.mercury);\n      this.off();\n      URL.revokeObjectURL(this.localMediaStreamUrl);\n      this.localMediaStreamUrl = undefined;\n      URL.revokeObjectURL(this.remoteMediaStreamUrl);\n      this.remoteMediaStreamUrl = undefined;\n    });\n\n    this.pc = new RTCPeerConnection({iceServers: []});\n    // TODO given all the other chrome/ff discrepancies, make sure this works in\n    // both browsers\n    this.pc.ontrack = (event) => {\n      this.remoteMediaStream = event.streams[0];\n    };\n\n    this.on(`change:remoteMediaStream`, () => {\n      if (this.remoteMediaStreamUrl) {\n        URL.revokeObjectURL(this.remoteMediaStreamUrl);\n      }\n      this.remoteMediaStreamUrl = URL.createObjectURL(this.remoteMediaStream);\n    });\n\n    this.on(`change:remoteMediaStreamUrl`, () => {\n      this.trigger(`remoteMediaStream:change`);\n    });\n\n    this.on(`change:localMediaStreamUrl`, () => {\n      this.trigger(`localMediaStream:change`);\n    });\n\n    this.on(`change:remoteAudioMuted`, () => {\n      this.trigger(`remoteAudioMuted:change`);\n    });\n\n    this.on(`change:remoteVideoMuted`, () => {\n      this.trigger(`remoteVideoMuted:change`);\n    });\n\n    this.on(`change:isActive`, () => {\n      if (!this.isActive) {\n        if (this.joinedOnThisDevice) {\n          this.logger.info(`call: hanging up due to locus going inactive`);\n          this.hangup();\n        }\n      }\n    });\n\n    this.on(`change:activeParticipantsCount`, () => {\n      const previousLocus = this.previousAttributes().locus;\n      // TODO this logic probably goes in state-parsers\n      if (this.joinedOnThisDevice && this.activeParticipantsCount === 1 && previousLocus && activeParticipants(previousLocus).length > 1) {\n        this.logger.info(`call: hanging up due to last participant in call`);\n        this.hangup();\n      }\n    });\n\n    this.on(`change:status`, () => {\n      switch (this.status) {\n      case `ringing`:\n        this.trigger(`ringing`);\n        break;\n      case `connected`:\n        this.trigger(`connected`);\n        break;\n      case `disconnected`:\n        this.trigger(`disconnected`);\n        break;\n      default:\n        // do nothing\n      }\n    });\n  },\n\n  /**\n   * Answers an incoming call. Only applies to incoming calls. Invoking this\n   * method on an outgoing call is a noop\n   * @instance\n   * @memberof Call\n   * @param {Object} options\n   * @param {MediaStreamConstraints} options.constraints\n   * @returns {Promise}\n   */\n  answer(options) {\n    // TODO make this a noop for outbound calls\n    this.logger.info(`call: answering`);\n    // Locus may *think* we're connected if we e.g. reload the page mid-call. If\n    // the user decides to answer the in-progress call that locus thinks they're\n    // a part of, we should immediately emit the connected event.\n    if (this.joinedOnThisDevice) {\n      this.logger.info(`call: already joined on this device`);\n    }\n    return this._join(`join`, this.locus, options)\n      .then(tap(() => this.logger.info(`call: answered`)));\n  },\n\n  /**\n   * Use to acknowledge (without answering) an incoming call. Will cause the\n   * initiator's Call instance to emit the ringing event.\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  acknowledge() {\n    this.logger.info(`call: acknowledging`);\n    // TODO call this method automatically unless config says otherwise\n    return this.spark.locus.alert(this.locus)\n      .then((locus) => this._setLocus(locus))\n      .then(tap(() => this.logger.info(`call: acknowledged`)));\n  },\n\n  /**\n   * Used by {@link Phone#dial} to initiate an outbound call\n   * @instance\n   * @memberof Call\n   * @param {[type]} invitee\n   * @param {[type]} options\n   * @private\n   * @returns {[type]}\n   */\n  dial(invitee, options) {\n    this.logger.info(`call: dialing`);\n    this._join(`create`, invitee, options)\n      .then(tap(() => this.logger.info(`call: dialed`)))\n      .catch((reason) => {\n        this.trigger(`error`, reason);\n      });\n\n    return this;\n  },\n\n  /**\n   * Disconnects the active call. Applies to both incoming and outgoing calls.\n   * This method may be invoked in any call state and the SDK should take care\n   * to tear down the call and free up all resources regardless of the state.\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  hangup() {\n    // TODO For example, hangup may be invoked immediately after invoking dial()\n    // but before the “locus” has been created. In this case  invoking  hangup()\n    // should short circuit the call setup process and take whatever action is\n    // necessary to ensure all parties are notified that the call is\n    // disconnected.\n    // TODO For incoming calls, invoking hangup should be synonymous with\n    // invoking reject()\n    this.logger.info(`call: hanging up`);\n\n    end(this.pc);\n\n    if (!this.locus) {\n      if (this.locusJoinInFlight) {\n        this.logger.info(`call: no locus, waiting for rest call to complete before hanging up`);\n        return this.when(`change:locus`)\n          .then(() => this.hangup());\n      }\n\n      this.stopListening(this.spark.mercury);\n      this.off();\n      this.logger.info(`call: hang up complete, call never created`);\n      return Promise.resolve();\n    }\n\n    return this._hangup();\n  },\n\n  /**\n   * Does the internal work necessary to end a call while allowing hangup() to\n   * call itself without getting stuck in promise change because of oneFlight\n   * @private\n   * @returns {Promise}\n   */\n  @oneFlight\n  _hangup() {\n    this.locusLeaveInFlight = true;\n    return this.spark.locus.leave(this.locus)\n      .then((locus) => this._setLocus(locus))\n      .then(() => {\n        this.locusLeaveInFlight = false;\n      })\n      .then(() => this.set({\n        sendingAudio: false,\n        sendingVideo: false,\n        receivingAudio: false,\n        receivingVideo: false\n      }))\n      .then(tap(() => this.stopListening(this.spark.mercury)))\n      .then(tap(() => this.off()))\n      .then(tap(() => this.logger.info(`call: hung up`)));\n  },\n\n  /**\n   * Alias of {@link Call#reject}\n   * @see {@link Call#reject}\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  decline() {\n    return this.reject();\n  },\n\n  /**\n   * Rejects an incoming call. Only applies to incoming calls. Invoking this\n   * method on an outgoing call is a no-op.\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  @oneFlight\n  reject() {\n    // TODO should be a noop for outgoing calls\n    this.logger.info(`call: rejecting`);\n    /* eslint no-invalid-this: [0] */\n    return this.spark.locus.decline(this.locus)\n      .then((locus) => this._setLocus(locus))\n      .then(tap(() => this.stopListening(this.spark.mercury)))\n      .then(tap(() => this.off()))\n      .then(tap(() => this.logger.info(`call: rejected`)));\n  },\n\n  /**\n   * Starts sending audio to the Cisco Spark Cloud\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  startSendingAudio() {\n    return this._changeMedia({sendingAudio: true});\n  },\n\n  /**\n   * Starts sending video to the Cisco Spark Cloud\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  startSendingVideo() {\n    return this._changeMedia({sendingVideo: true});\n  },\n\n  startReceivingAudio() {\n    return this._changeMedia({receivingAudio: true});\n  },\n\n  startReceivingVideo() {\n    return this._changeMedia({receivingVideo: true});\n  },\n\n  /**\n   * Toggles receiving audio to the Cisco Spark Cloud\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  toggleReceivingAudio() {\n    return this.receivingAudio ? this.stopReceivingAudio() : this.startReceivingAudio();\n  },\n\n  /**\n   * Toggles receiving video to the Cisco Spark Cloud\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  toggleReceivingVideo() {\n    return this.receivingVideo ? this.stopReceivingVideo() : this.startReceivingVideo();\n  },\n\n  stopReceivingAudio() {\n    return this._changeMedia({receivingAudio: false});\n  },\n\n  stopReceivingVideo() {\n    return this._changeMedia({receivingVideo: false});\n  },\n\n  /**\n   * Toggles sending audio to the Cisco Spark Cloud\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  toggleSendingAudio() {\n    return this.sendingAudio ? this.stopSendingAudio() : this.startSendingAudio();\n  },\n\n  /**\n   * Toggles sending video to the Cisco Spark Cloud\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  toggleSendingVideo() {\n    return this.sendingVideo ? this.stopSendingVideo() : this.startSendingVideo();\n  },\n\n  /**\n   * Sends feedback about the call to the Cisco Spark cloud\n   * @instance\n   * @memberof Call\n   * @param {Types~Feedback} feedback\n   * @returns {Promise}\n   */\n  sendFeedback(feedback) {\n    return this.spark.metrics.submit(`meetup_call_user_rating`, feedback);\n  },\n\n  /**\n   * Stops sending audio to the Cisco Spark Cloud. (stops broadcast immediately,\n   * even if renegotiation has not completed)\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  stopSendingAudio() {\n    return this._changeMedia({sendingAudio: false});\n  },\n\n  /**\n   * Stops sending video to the Cisco Spark Cloud. (stops broadcast immediately,\n   * even if renegotiation has not completed)\n   * @instance\n   * @memberof Call\n   * @returns {Promise}\n   */\n  stopSendingVideo() {\n    return this._changeMedia({sendingVideo: false});\n  },\n\n  _changeMedia(constraints) {\n    return new Promise((resolve) => {\n      /* eslint complexity: [0] */\n      if (!this.pc) {\n        resolve();\n        return;\n      }\n\n      constraints = defaults({}, constraints, {\n        sendingVideo: this.sendingVideo,\n        sendingAudio: this.sendingAudio,\n        receivingVideo: this.receivingVideo,\n        receivingAudio: this.receivingAudio\n      });\n\n      constraints = Object.assign({}, constraints, {\n        wasSendingAudio: this.sendingAudio,\n        wasSendingVideo: this.sendingVideo,\n        wasReceivingAudio: this.receivingAudio,\n        wasReceivingVideo: this.receivingVideo\n      });\n\n      this.set(constraints);\n\n      const promises = [];\n      if (constraints.sendingAudio && !constraints.wasSendingAudio) {\n        promises.push(startSendingAudio(this.pc));\n      }\n\n      if (!constraints.sendingAudio && constraints.wasSendingAudio) {\n        promises.push(stopSendingAudio(this.pc));\n      }\n\n      if (constraints.sendingVideo && !constraints.wasSendingVideo) {\n        promises.push(startSendingVideo(this.pc));\n      }\n\n      if (!constraints.sendingVideo && constraints.wasSendingVideo) {\n        promises.push(stopSendingVideo(this.pc));\n      }\n\n      if (constraints.receivingAudio && !constraints.wasReceivingAudio) {\n        promises.push(startReceivingAudio(this.pc));\n      }\n\n      if (!constraints.receivingAudio && constraints.wasReceivingAudio) {\n        promises.push(stopReceivingAudio(this.pc));\n      }\n\n      if (constraints.receivingVideo && !constraints.wasReceivingVideo) {\n        promises.push(startReceivingVideo(this.pc));\n      }\n\n      if (!constraints.receivingVideo && constraints.wasReceivingVideo) {\n        promises.push(stopReceivingVideo(this.pc));\n      }\n\n\n      resolve(Promise.all(promises)\n        .then(() => this._updateMedia())\n        .then(() => this.unset([\n          `wasSendingAudio`,\n          `wasSendingVideo`,\n          `wasReceivingAudio`,\n          `wasReceivingVideo`\n        ])));\n    });\n  },\n\n  _join(locusMethodName, target, options) {\n    options = options || {};\n    options.constraints = defaults(options.constraints, {\n      audio: true,\n      video: true\n    });\n    const recvOnly = !options.constraints.audio && !options.constraints.video;\n    options.offerOptions = defaults(options.offerOptions, {\n      offerToReceiveAudio: recvOnly || options.constraints.audio,\n      offerToReceiveVideo: recvOnly || options.constraints.video\n    });\n\n    let promise;\n    if (!recvOnly) {\n      promise = Promise.resolve(options.localMediaStream || this.spark.phone.createLocalMediaStream(options))\n        .then((localMediaStream) => {\n          this.localMediaStream = localMediaStream;\n          this.localMediaStreamUrl = URL.createObjectURL(localMediaStream);\n          addStream(this.pc, localMediaStream);\n        });\n    }\n\n    const wantsVideo = options.constraints.video || options.offerOptions.offerToReceiveVideo;\n\n    return Promise.resolve(promise)\n      .then(() => createOffer(this.pc, options.offerOptions))\n      .then((offer) => {\n        if (!wantsVideo) {\n          return offer;\n        }\n        return ensureH264(offer);\n      })\n      .then((offer) => {\n        this.locusJoinInFlight = true;\n        return this.spark.locus[locusMethodName](target, {\n          localSdp: offer\n        });\n      })\n      .then((locus) => {\n        this._setLocus(locus);\n        this.locusJoinInFlight = false;\n        const answer = JSON.parse(this.mediaConnection.remoteSdp).sdp;\n        return acceptAnswer(this.pc, answer);\n      })\n      .then(() => {\n        this.set({\n          sendingAudio: options.constraints.audio,\n          sendingVideo: options.constraints.video,\n          receivingAudio: options.offerOptions.offerToReceiveAudio,\n          receivingVideo: options.offerOptions.offerToReceiveVideo\n        });\n      });\n  },\n\n  _onLocusEvent(event) {\n    if (this.locus && event.data.locus.url === this.locus.url) {\n      this.logger.info(`locus event: ${event.data.eventType}`);\n      this._setLocus(event.data.locus);\n    }\n  },\n\n  _setLocus(incoming) {\n    const current = this.locus;\n    if (!current) {\n      this.locus = incoming;\n      return Promise.resolve();\n    }\n    const action = this.spark.locus.compare(current, incoming);\n\n    switch (action) {\n    case USE_INCOMING:\n      this.locus = incoming;\n      break;\n    case FETCH:\n      return this.spark.locus.get(current)\n         .then((locus) => this._setLocus(locus));\n    default:\n      // do nothing\n    }\n\n    return Promise.resolve();\n  },\n\n  @oneFlight\n  _updateMedia() {\n    /* eslint max-nested-callbacks: [0] */\n    return new Promise((resolve) => {\n      process.nextTick(() => {\n        resolve(createOffer(this.pc, {\n          offerToReceiveAudio: this.receivingAudio,\n          offerToReceiveVideo: this.receivingVideo\n        })\n          .then((offer) => this.spark.locus.updateMedia(this.locus, {\n            localSdp: offer,\n            mediaId: this.mediaId,\n            audioMuted: !this.sendingAudio,\n            videoMuted: !this.sendingVideo\n          }))\n          .then((locus) => {\n            this._setLocus(locus);\n            const sdp = JSON.parse(this.mediaConnection.remoteSdp).sdp;\n            return acceptAnswer(this.pc, sdp);\n          }));\n      });\n    });\n  }\n});\n\nCall.make = function make(attrs, options) {\n  return new Call(attrs, options);\n};\n\nexport default Call;\n"]}